<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KinoXP - Worker Dashboard</title>
  <link rel="stylesheet" href="/css/footer.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const isLoggedIn = sessionStorage.getItem('isLoggedIn');
      if (isLoggedIn !== 'true') {
        window.location.href = '/';
      }
    });
  </script>
  <style>
      a {
          text-decoration: none;
      }
      body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }
    .background {
      background-image: url('https://wallpapercave.com/wp/wp2508260.jpg');
      background-size: cover;
      background-position: center;
      padding-top: 100px;
    }

    .title-container {
      text-align: center;
      margin-bottom: 80px;
    }

    .dashboard-title {
      color: white;
      font-size: 2em;
    }

    .box-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 25px;
      margin-bottom: 25px;
    }

    .box {
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      border-radius: 10px;
      margin: 0 auto;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s;
    }

    .box:hover {
      transform: scale(1.02);
    }

    .box-header {
      cursor: pointer;
      padding: 15px;
      background-color: #0056b3;
      border-radius: 5px;
      margin-bottom: 10px;
      text-align: center;
      font-size: 1.25em;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .box-header:hover {
      background-color: #004494;
    }

    .box-content {
      display: none;
      padding: 10px;
      border: 1px solid #fff;
      border-radius: 5px;
      background-color: rgba(255, 255, 255, 0.1);
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }

    input[type="text"], input[type="date"], input[type="time"] {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin-bottom: 10px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }

    .booking-details {
      margin-top: 15px;
    }
  </style>
</head>
<body>
<div id="header-placeholder"></div>

<div id="app" class="background">
  <div class="title-container">
    <h1 class="dashboard-title">Medarbejder Dashboard</h1>
  </div>
  <div class="box-container">
    <div class="box">
      <div class="box-header" id="toggle-search">
        <h2>Søg på Ticket ID</h2>
      </div>
      <div class="box-content" id="search-content">
        <label for="search-ticket-id">Indtast Ticket ID:</label>
        <input type="text" id="search-ticket-id" style="width: 97%">
        <button id="search-button">Søg</button>
        <div id="booking-details" class="booking-details" style="width: 97%"></div>
      </div>
    </div>

    <div class="box">
      <div class="box-header" id="toggle-date-search">
        <h2>Søg for dato</h2>
      </div>
      <div class="box-content" id="date-search-content">
        <label for="search-date">Søg for dato:</label>
        <input type="date" id="search-date" style="width: 97%">
        <button id="date-search-button">Søg</button>
        <div id="date-booking-details" class="booking-details" style="width: 97%"></div>
      </div>
    </div>
  </div>
  <a href="/Arbejdsuge" target="_blank"><div class="box">
    <div class="box-header" id="vagtplan">
      <h2>Vagt Planlægning</h2>
    </div>
    <div class="box-content" id="vagtplan-content">
    </div>
  </div></a>
    <div class="box">
        <div class="box-header" id="toggle-candy">
            <h2>Administrer Slik</h2>
        </div>
        <div class="box-content" id="candy-content">
            <label for="candy-name">Slik Navn:</label>
            <input type="text" id="candy-name" class="candy-input" placeholder="Indtast navn">
            <label for="candy-price">Pris:</label>
            <input type="text" id="candy-price" class="candy-input" placeholder="Indtast pris">
            <button id="add-candy">Tilføj Slik</button>
            <div id="candy-list"></div>
        </div>
    </div>
</div>



<div id="footer-placeholder"></div>
</body>
<script>
  $(document).ready(function () {
    $('#header-placeholder').load('/fragments/header');
    $('#cookie-placeholder').load('/fragments/cookies');
    $('#footer-placeholder').load('/fragments/footer');


    $('#toggle-search').click(function () {
      $('#search-content').slideToggle();
    });

    $('#toggle-date-search').click(function () {
      $('#date-search-content').slideToggle();
    });

    // formatering af extras til display fra datahandler getItems hvis der skulle tilføjes nye
    function formatExtrasDisplay(extras, items, editable = false) {
      return items.map(item => {
        const quantity = extras && extras[item.name] ? extras[item.name] : "0";
        if (editable) {
          return `
                <div class="extra-item-row">
                    <span class="extra-item-name">${item.name} (${item.price} kr)</span>
                    <input type="number"
                           class="extra-item-quantity"
                           data-item-name="${item.name}"
                           value="${quantity}"
                           min="0"
                           style="width: 60px; margin-left: 10px;">
                </div>`;
        } else {
          if (quantity !== "0") {
            return `<div class="extra-item-row">
                    ${item.name}: ${quantity}
                </div>`;
          }
          return `<div class="extra-item-row extra-item-zero">
                ${item.name}: ${quantity}
            </div>`;
        }
      }).join('');
    }
    // Helper funktion til extras
    function collectExtrasFromForm(container) {
      const extras = {};
      container.find('.extra-item-quantity').each(function() {
        const quantity = $(this).val();
        const itemName = $(this).data('item-name');
        if (quantity && parseInt(quantity) > 0) {
          extras[itemName] = quantity;
        }
      });
      return extras;
    }

    function displayBookingDetails(booking, container) {
      $.getJSON('/api/items', function(items) {
        container.empty();
        if (booking) {
          container.append(`
                <div class="booking">
                    <p><strong>Ticket ID:</strong> <span class="editable" data-field="ticketID">${booking.ticketID}</span></p>
                    <p><strong>Filmtitel:</strong> <span class="editable" data-field="movieTitle">${booking.movieTitle}</span></p>
                    <p><strong>Visningstid:</strong> <span class="editable" data-field="showtime">${booking.showtime}</span></p>
                    <p><strong>Valgte pladser:</strong> <span class="editable" data-field="selectedSeats">${booking.selectedSeats.join(', ')}</span></p>
                    <p><strong>Total pris:</strong> <span class="editable" data-field="totalPrice">${booking.totalPrice}</span></p>
                    <p><strong>Dato:</strong> <span class="editable" data-field="date">${booking.date}</span></p>
                    <div class="extras-section">
                        <p><strong>Ekstra:</strong></p>
                        <div class="extras-container" data-items='${JSON.stringify(items)}'>
                            ${formatExtrasDisplay(booking.extras, items)}
                        </div>
                    </div>
                    <button class="edit-button">Rediger</button>
                    <button class="save-button" style="display:none;">Gem</button>
                    <button class="delete-button" data-ticket-id="${booking.ticketID}">Slet</button>
                </div>
            `);
        } else {
          container.text('Ingen booking fundet.');
        }
      });
    }

    $('#search-button').click(function () {
      const ticketId = $('#search-ticket-id').val().trim();
      console.log("Searching for Ticket ID:", ticketId);
      $.getJSON('/api/tickets', function (data) {
        const booking = data.find(b => b.ticketID === ticketId);
        displayBookingDetails(booking, $('#booking-details'));
      }).fail(function () {
        alert('Fejl ved hentning af billetdata.');
      });
    });

    $('#date-search-button').click(function () {
      const selectedDate = $('#search-date').val().trim();
      if (!selectedDate) {
        alert('Please select a date.');
        return;
      }

      const dateParts = selectedDate.split('-');
      const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
      console.log("Searching for Date:", formattedDate);

      $.getJSON('/api/ticketsarray', function (data) {
        const bookingsForDate = data.tickets.filter(b => b.date === formattedDate);
        $('#date-booking-details').empty();
        if (bookingsForDate.length > 0) {
          bookingsForDate.forEach(booking => {
            const bookingContainer = $('<div>').appendTo('#date-booking-details');
            displayBookingDetails(booking, bookingContainer);
          });
        } else {
          $('#date-booking-details').text('Ingen booking fundet på denne dato.');
        }
      });
    });

    $('#booking-details, #date-booking-details').on('click', '.edit-button', function () {
      const booking = $(this).closest('.booking');
      const ticketId = booking.find('span[data-field="ticketID"]').text();
      $(this).hide();
      $(this).siblings('.save-button').show();
      $(this).data('ticketId', ticketId);

      // Behold Ticket ID, movieTitle, dato mm, da de ikke skal kunne ændres.
      booking.find('.editable').each(function () {
        const currentValue = $(this).text();
        const field = $(this).data('field');
        if (field !== 'ticketID' && field !== 'movieTitle' && field !== 'date' && field !== 'showtime') {
          $(this).replaceWith(`<input type="text" class="edit-input" data-field="${field}" value="${currentValue}"/>`);
        }
      });

      // Deling af sæder
      const selectedSeats = booking.find('span[data-field="selectedSeats"]').text();
      const seatArray = selectedSeats.split(',').map(seat => seat.trim()); // Split
      booking.find('span[data-field="selectedSeats"]').replaceWith(
              `<textarea class="edit-input" data-field="selectedSeats" rows="3">${seatArray.join('\n')}</textarea>`
      );


      // Extras (popcorn, sodavand osv) tilføjelser - virker nu også hvis der bliver tilføjet nye varer
      const extrasContainer = booking.find('.extras-container');
      const items = JSON.parse(extrasContainer.attr('data-items'));
      const currentExtras = {};
      extrasContainer.find('.extra-item-row').each(function() {
        const text = $(this).text().trim();
        const [name, quantity] = text.split(':').map(s => s.trim());
        if (quantity !== '0') {
          currentExtras[name] = quantity;
        }
      });
      extrasContainer.html(formatExtrasDisplay(currentExtras, items, true));
    });



    $('#booking-details, #date-booking-details').on('click', '.delete-button', function () {
      const ticketId = $(this).data('ticket-id');

      if (confirm('Er du sikker på, at du vil slette denne billet?')) {
        $.ajax({
          url: '/api/tickets/delete',
          type: 'DELETE',
          contentType: 'application/json',
          data: JSON.stringify({ ticketID: ticketId }),
          success: function () {
            alert('Billet slettet med succes!');
            $(this).closest('.booking').remove(); // Slettes fra UI
            $('#search-ticket-id').val(''); // Renser ticket id
            $('#booking-details').empty(); // Renser booking detaljer
          }.bind(this), //
          error: function (xhr) {
            console.error("Error details:", xhr.responseText);
            alert('Kunne ikke slette billetten. Prøv venligst igen.');
          }
        });
      }
    });

    $('#booking-details, #date-booking-details').on('click', '.save-button', function () {
      const booking = $(this).closest('.booking');
      const ticketId = $(this).siblings('.edit-button').data('ticketId');

      // Sørger for korrekt save af arrayliste af sædevalg.
      const selectedSeats = $('.edit-input[data-field="selectedSeats"]').val()
              .split(/(?=Række)/) // Split
              .map(seat => seat.trim()) // Fjerner tom plads, hvis man glemmer et mellemrum eller lign..
              .filter(seat => seat && !seat.startsWith(',')) // fjerner tomme værdier
              .map(seat => seat.replace(/,\s*$/, '')); // fjerner komma foran eller bagved.

      function calculateExtrasTotalPrice(container) {
        const extras = collectExtrasFromForm(container);
        const items = JSON.parse(container.find('.extras-container').attr('data-items')); // Henter priser
        let totalPrice = 0;

        for (const [itemName, quantity] of Object.entries(extras)) {
          const item = items.find(i => i.name === itemName); // Find the item details
          if (item) {
            totalPrice += item.price * parseInt(quantity); // Udregner totalpris
          }
        }

        return totalPrice; // Extra totalpris
      }
      const pricePerSeat = 100; // 100kr pr sæde
      const numberOfSeats = selectedSeats.length;
      const extrasTotalPrice = calculateExtrasTotalPrice(booking);
      const totalPrice = (numberOfSeats * pricePerSeat) + extrasTotalPrice; // Løbende udregning af totalpris ved edit

      const updatedBooking = {
        ticketID: ticketId,
        movieTitle: booking.find('span[data-field="movieTitle"]').text() || '',
        showtime: booking.find('span[data-field="showtime"]').text() || '',
        selectedSeats: selectedSeats,
        totalPrice: totalPrice,
        date: booking.find('span[data-field="date"]').text() || '',
        extras: collectExtrasFromForm(booking)
      };

      // Debug
      console.log("Updated Booking:", updatedBooking);

      // debug
      if (!updatedBooking.movieTitle || !updatedBooking.showtime || !updatedBooking.date) {
        alert('Please make sure all required fields are filled.');
        return;
      }

      $.ajax({
        url: '/api/tickets/update',
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(updatedBooking),
        success: function () {
          alert('Booking opdateret med succes!');
          if (booking.closest('#booking-details').length) {
            $('#search-ticket-id').val('');
            $('#booking-details').empty();
          } else {
            $('#date-booking-details').empty();
          }
        },
        error: function (xhr) {
          console.error("Error details:", xhr.responseText);
          alert('Kunne ikke opdatere booking. Prøv venligst igen.');
        }
      });
    });
      $('#toggle-candy').click(function() {
          $('#candy-content').slideToggle(() => {
              if ($('#candy-content').is(':visible')) {
                  loadCandy();
              }
          });
      });

      $('#add-candy').click(addCandy);

      function loadCandy() {
          fetch('/api/items')
              .then(response => response.json())
              .then(items => {
                  let candyList = document.getElementById("candy-list");
                  candyList.innerHTML = "";
                  items.forEach((item, index) => {
                      candyList.innerHTML += `
              <div id="candy-item-${index}" class="candy-item">
                <span class="text-display">${item.name} - ${item.price} DKK</span>
                <input type="text" class="edit-candy-name" value="${item.name}" data-index="${index}" />
                <input type="text" class="edit-candy-price" value="${item.price}" data-index="${index}" />
                <button onclick="editCandy(${index})" class="edit-button">Rediger</button>
                <button onclick="saveCandy(${index})" class="save-button" style="display: none;">Gem</button>
                <button onclick="deleteCandy(${index})">Slet</button>
              </div>
            `;
                  });
              });
      }

      function addCandy() {
          const name = document.getElementById("candy-name").value;
          const price = document.getElementById("candy-price").value;

          fetch('/api/items', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, price })
          }).then(() => loadCandy());
      }

      window.editCandy = function(index) {
          const candyItem = $(`#candy-item-${index}`);
          candyItem.addClass('editing');
          candyItem.find('.edit-button').hide();
          candyItem.find('.save-button').show();
      };

      window.saveCandy = function(index) {
          const candyItem = $(`#candy-item-${index}`);
          const name = candyItem.find('.edit-candy-name').val();
          const price = candyItem.find('.edit-candy-price').val();

          fetch(`/api/items/${index}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, price })
          }).then(() => {
              loadCandy();
          });
      };

      window.deleteCandy = function(index) {
          fetch(`/api/items/${index}`, {
              method: 'DELETE'
          }).then(() => loadCandy());
      };
    const style = `
<style>
    .extras-container {
        margin-left: 20px;
    }
    .extra-item-row {
        margin: 5px 0;
        display: flex;
        align-items: center;
    }
    .extra-item-zero {
        color: #666;
    }
    .extra-item-name {
        min-width: 200px;
    }
    .extra-item-quantity {
        padding: 3px;
        border-radius: 3px;
        border: 1px solid #ccc;
    }
</style>
`;
    $(style).appendTo('head');
  });
</script>
</html>
